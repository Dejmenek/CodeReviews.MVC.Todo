@{
    ViewData["Title"] = "Home Page";
}

<button type="button" class="btn btn-success" id="create">Create To do</button>
<br />
<br />
<div class="forms" id="forms" style="display: none;">
    <div class="form-group" id="createform">
        <label for="exampleInputEmail1">To do name</label>
        <input type="email" class="form-control" id="todoname" placeholder="Enter your to do's name'">
    </div>
    <div class="form-group">
        <input type="submit" value="Create" id="submitbutton" class="btn btn-success" />
    </div>
</div>

<div class="todolist">
    <ul id="todolist">

    </ul>
</div>


@section Scripts{
    <script>
        const createButton = document.querySelector("#create");
        const forms = document.querySelector("#forms");
        const submitButton = document.querySelector("#submitbutton");
        const todoList = document.getElementById("todolist");


        createButton.addEventListener('click', function(){
            forms.style.display = "block";
        })

        var URL = "https://localhost:7280/todoitems/";
        const addedTodosNames = [];
        var responseJson;

        GetTodoList();
        console.log("From app start")

        function GetTodoList()
        {
            fetch(URL)
                .then(response => response.json())
                .then(data => {
                    responseJson = data;
                    data.forEach((d) => {
                        var li = document.createElement("li");
                        var deleteButton = document.createElement("button");
                        deleteButton.classList.add('btn', 'btn-danger');
                        deleteButton.textContent = 'Delete';
                        li.appendChild(document.createTextNode(d.name));
                        li.appendChild(deleteButton);
                        deleteButton.addEventListener('click', function () { DeleteTodo(d) })
                        todoList.appendChild(li);

                        var updateButton = document.createElement("button");
                        var markAsCompleteButton = document.createElement("button");
                        var markAsIncompleteButton = document.createElement("button");
                        var updateSubmitButton = document.createElement("button");
                        updateButton.classList.add('btn', 'btn-primary');
                        updateButton.textContent = 'Update';
                        markAsCompleteButton.classList.add('btn', 'btn-success');
                        markAsCompleteButton.textContent = 'Mark as complete';
                        markAsIncompleteButton.classList.add('btn', 'btn-secondary');
                        markAsIncompleteButton.textContent = 'Mark as incomplete';
                        updateSubmitButton.classList.add('btn', 'btn-success');
                        updateSubmitButton.textContent = 'Submit';

                        if (d.isComplete == false){
                            li.style.color = "black";
                            li.appendChild(markAsCompleteButton);
                        }
                        else if (d.isComplete == true){
                            li.style.color = "green";
                            li.appendChild(markAsIncompleteButton);
                        }

                        li.appendChild(updateButton);

                        markAsCompleteButton.addEventListener('click', () => {
                            li.style.color = "green";
                            li.replaceChild(markAsIncompleteButton, markAsCompleteButton);
                            d.isComplete = true;
                            UpdateTodo(d);
                        })

                        markAsIncompleteButton.addEventListener('click', () => {
                            li.style.color = "black";
                            li.replaceChild(markAsCompleteButton, markAsIncompleteButton);
                            d.isComplete = false;
                            UpdateTodo(d);
                        })

                        updateButton.addEventListener('click', () => {
                            var todoNameInputField = document.createElement("input");
                            todoNameInputField.setAttribute('type', 'text');
                            todoNameInputField.setAttribute('placeholder', 'Insert the new name of your to do');
                            todoNameInputField.setAttribute('id', 'updatetodo')
                            li.appendChild(todoNameInputField);
                            li.appendChild(updateSubmitButton);
                        })
                        updateSubmitButton.addEventListener('click', () => {
                            console.log(d);
                            d.name = document.getElementById("updatetodo").value;
                            console.log(d);
                            UpdateTodo(d);
                        })

                        console.log(d.name + d.id);
                    })
                    console.log(data);
                })
                .catch(error => {
                    console.error(error);
                });
        }
        
        function DeleteTodo(d){
            console.log("asd");
            var URL = "https://localhost:7280/todoitems/" + encodeURIComponent(d.id)
            console.log(URL);
            var dataObject = {
                "id": d.id,
                "name": d.name,
                "isComplete": d.isComplete
            }
            fetch(URL, {
                method: "DELETE",
                body: JSON.stringify(dataObject),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(() => 
            {
                location.reload();
                console.log("It was deleted")
            })
        }

        function UpdateTodo(d) {
            console.log("asd");
            var URL = "https://localhost:7280/todoitems/" + encodeURIComponent(d.id)
            console.log(URL);
            var dataObject = {
                "id": d.id,
                "name": d.name,
                "isComplete": d.isComplete
            }
            fetch(URL, {
                method: "PUT",
                body: JSON.stringify(dataObject),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(() => 
            {
                location.reload();
                console.log("It was updated")
            })
        }


        
        submitButton.addEventListener('click', function() { PostToDo() });

        function PostToDo() {
            var todoName = document.getElementById("todoname").value;
            const areThereDuplicatedValues = addedTodosNames.some((x) => x == todoName)
            if (todoName === "") {
                alert("Please enter a todo name");
                return;
            }
            else if (areThereDuplicatedValues == true) {
                alert("Please don't enter a todo you added before");
                return;
            }

            var data = {
                "name": todoName,
                "isComplete": false
            };

            fetch(URL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(() => 
            {
                location.reload()
                console.log("It was posted");
            })
        }
    </script>
}